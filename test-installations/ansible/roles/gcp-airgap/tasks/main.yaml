# Copyright (c) 2022 Gitpod GmbH. All rights reserved.
# Licensed under the GNU Affero General Public License (AGPL).
# See License-AGPL.txt in the project root for license information.

---
- name: Delete access config
  command: "gcloud compute instances delete-access-config {{ gitpod_node_prefix }}--node-{{ item }} --access-config-name='external-nat'"
  loop: "{{ range(0, gitpod_nodes_count) | list }}"
  ignore_errors: true

- name: Create jumpbox / bastion host
  google.cloud.gcp_compute_instance:
    name: "{{ bastion_name }}"
    machine_type: "{{ gcp_machine_type }}"
    disks:
    - auto_delete: 'true'
      boot: 'true'
      initialize_params:
        disk_size_gb: 256
        source_image: projects/ubuntu-os-cloud/global/images/family/ubuntu-2004-lts
    network_interfaces:
    - access_configs:
      - name: external-nat
        type: ONE_TO_ONE_NAT
    labels:
      instance: "{{ bastion_name }}"
    zone: "{{ gcp_zone }}"
    project: "{{ gcp_project }}"
    auth_kind: serviceaccount
    service_account_contents: "{{ gcp_cred_content }}"
    service_accounts:
      - email: "{{ gcp_cred_content.client_email }}"
        scopes:
          - "https://www.googleapis.com/auth/compute"
    state: present
  register: gcpvm

# - name: Install Gitpod
#  command: gcloud compute ssh --quiet {{ bastion_name }} --command "gcloud compute ssh --quiet {{ gitpod_node_prefix }}--node-0 --zone {{ gcp_zone }} --command 'sudo cp /gitpod/gitpod-manifests.yaml /var/lib/rancher/k3s/server/manifests/gitpod-manifests.yaml' --internal-ip"


#   # - name: Verify missing internet access
#   #   command: "gcloud compute ssh --ssh-flag=-A gitlab -- \"ssh {{ gitpod_node_prefix }}--node-{{ item }} 'curl -v https://kubernetes.io' \""
#   #   loop: "{{ range(0, gitpod_nodes_count) | list }}"
#   - name: Verify missing internet access
#     command: "gcloud compute ssh gitlab --command \"ssh -tt -o StrictHostKeyChecking=no {{ gitpod_node_prefix }}--node-{{ item }} 'curl -v https://kubernetes.io' \" -- -A -tt"
#     loop: "{{ range(0, gitpod_nodes_count) | list }}"
#   tags: ["x"]


# https://cloud.google.com/compute/docs/instances/connecting-advanced#gcloud_1
# gcloud compute instances set-service-account gitlab --service-account self-hosted-integration-tests@clu-self-hosted-playground.iam.gserviceaccount.com --scopes compute-rw